enum AddressType {
  HOME
  OFFICE
  OTHER
}

model Address {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  fullName     String      @map("full_name") @db.VarChar(255)
  phone        String      @db.VarChar(20)
  addressLine1 String      @map("address_line1") @db.VarChar(255)
  addressLine2 String?     @map("address_line2") @db.VarChar(255)
  city         String      @db.VarChar(100)
  province     String      @db.VarChar(100)
  postalCode   String      @map("postal_code") @db.VarChar(20)
  country      String      @default("Vietnam") @db.VarChar(100)
  type         AddressType @default(HOME)
  isDefault    Boolean     @default(false) @map("is_default")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@map("addresses")
}

model Affiliate {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  code            String   @unique @db.VarChar(50)
  status          String   @default("pending") @db.VarChar(50)
  totalEarnings   Decimal  @default(0) @map("total_earnings") @db.Decimal(10, 2)
  paidEarnings    Decimal  @default(0) @map("paid_earnings") @db.Decimal(10, 2)
  pendingEarnings Decimal  @default(0) @map("pending_earnings") @db.Decimal(10, 2)
  bankAccount     String?  @map("bank_account") @db.VarChar(255)
  bankName        String?  @map("bank_name") @db.VarChar(255)
  accountHolder   String?  @map("account_holder") @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  links       AffiliateLink[]
  commissions AffiliateCommission[]

  @@index([code])
  @@index([userId])
  @@map("affiliates")
}

model AffiliateLink {
  id          String   @id @default(uuid())
  affiliateId String   @map("affiliate_id")
  productId   String?  @map("product_id")
  url         String   @db.VarChar(500)
  clicks      Int      @default(0)
  conversions Int      @default(0) @map("conversions")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([productId])
  @@map("affiliate_links")
}

model AffiliateCommission {
  id          String    @id @default(uuid())
  affiliateId String    @map("affiliate_id")
  orderId     String    @map("order_id")
  amount      Decimal   @db.Decimal(10, 2)
  rate        Decimal   @db.Decimal(5, 2)
  status      String    @default("pending") @db.VarChar(50)
  paidAt      DateTime? @map("paid_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([orderId])
  @@index([status])
  @@map("affiliate_commissions")
}

model CommissionRate {
  id         String   @id @default(uuid())
  productId  String?  @map("product_id")
  categoryId String?  @map("category_id")
  rate       Decimal  @db.Decimal(5, 2)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([categoryId])
  @@map("commission_rates")
}

enum BannerType {
  TEXT // Banner with text content (badge, title, description, etc)
  IMAGE // Banner with only image
}

enum BannerPosition {
  MAIN_CAROUSEL // Main carousel banner (left side)
  SIDE_TOP // Top side banner (right side)
  SIDE_BOTTOM // Bottom side banner (right side)
}

model BannerGroup {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  slug        String    @unique @db.VarChar(255)
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  banners BannerGroupMapping[]

  @@index([slug])
  @@index([isActive])
  @@map("banner_groups")
}

model Banner {
  id       String         @id @default(uuid())
  type     BannerType     @default(TEXT)
  position BannerPosition @default(MAIN_CAROUSEL)

  // Text content (for TEXT type)
  badge       String? @db.VarChar(100)
  title       String? @db.VarChar(255)
  description String? @db.Text
  highlight   String? @db.VarChar(255)
  ctaText     String? @map("cta_text") @db.VarChar(100)
  ctaLink     String? @map("cta_link") @db.VarChar(500)
  subLabel    String? @map("sub_label") @db.VarChar(255)

  // Styling - Gradient colors
  gradientFrom String? @map("gradient_from") @db.VarChar(50)
  gradientTo   String? @map("gradient_to") @db.VarChar(50)

  // Image (for IMAGE type or as background)
  imageMediaId String? @map("image_media_id")

  // Settings
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  groups     BannerGroupMapping[]
  imageMedia Media?               @relation("BannerImage", fields: [imageMediaId], references: [id], onDelete: SetNull)

  @@index([position])
  @@index([isActive])
  @@map("banners")
}

// Junction table for many-to-many relationship
model BannerGroupMapping {
  id            String   @id @default(uuid())
  bannerId      String   @map("banner_id")
  bannerGroupId String   @map("banner_group_id")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")

  banner      Banner      @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  bannerGroup BannerGroup @relation(fields: [bannerGroupId], references: [id], onDelete: Cascade)

  @@unique([bannerId, bannerGroupId])
  @@index([bannerId])
  @@index([bannerGroupId])
  @@map("banner_group_mappings")
}

// Email Verification Log - Audit trail for email verification activities

model EmailVerificationLog {
  id        String                  @id @default(uuid())
  userId    String                  @map("user_id")
  email     String                  @db.VarChar(255)
  action    EmailVerificationAction
  ipAddress String?                 @map("ip_address") @db.VarChar(45)
  userAgent String?                 @map("user_agent") @db.Text
  metadata  Json?
  createdAt DateTime                @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([action])
  @@index([createdAt])
  @@map("email_verification_logs")
}

enum EmailVerificationAction {
  SEND_OTP
  RESEND_OTP
  VERIFY_SUCCESS
  VERIFY_FAILED
  RATE_LIMITED
}

enum FlashSaleStatus {
  UPCOMING
  ACTIVE
  ENDED
  CANCELLED
}

model FlashSale {
  id          String          @id @default(uuid())
  name        String          @db.VarChar(255)
  description String?         @db.Text
  slug        String          @unique @db.VarChar(255)
  banner      String?         @db.VarChar(500)
  startTime   DateTime        @map("start_time")
  endTime     DateTime        @map("end_time")
  status      FlashSaleStatus @default(UPCOMING)
  isActive    Boolean         @default(true) @map("is_active")
  sortOrder   Int             @default(0) @map("sort_order")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  products FlashSaleProduct[]
  orders   FlashSaleOrder[]

  @@index([slug])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([isActive])
  @@map("flash_sales")
}

model FlashSaleProduct {
  id            String   @id @default(uuid())
  flashSaleId   String   @map("flash_sale_id")
  productId     String   @map("product_id")
  variantId     String?  @map("variant_id")
  flashPrice    Decimal  @map("flash_price") @db.Decimal(10, 2)
  originalPrice Decimal  @map("original_price") @db.Decimal(10, 2)
  maxQuantity   Int      @map("max_quantity")
  soldQuantity  Int      @default(0) @map("sold_quantity")
  limitPerOrder Int      @default(1) @map("limit_per_order")
  sortOrder     Int      @default(0) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  flashSale FlashSale       @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([flashSaleId, productId, variantId])
  @@index([flashSaleId])
  @@index([productId])
  @@index([variantId])
  @@index([isActive])
  @@map("flash_sale_products")
}

model FlashSaleOrder {
  id          String   @id @default(uuid())
  flashSaleId String   @map("flash_sale_id")
  orderId     String   @unique @map("order_id")
  createdAt   DateTime @default(now()) @map("created_at")

  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([flashSaleId])
  @@index([orderId])
  @@map("flash_sale_orders")
}

enum MediaType {
  PRODUCT_IMAGE
  PRODUCT_VIDEO
  REVIEW_IMAGE
  REVIEW_VIDEO
  AVATAR
  CATEGORY_IMAGE
  BRAND_LOGO
  BANNER_IMAGE
}

model Media {
  id           String    @id @default(uuid())
  url          String    @db.VarChar(500)
  key          String    @db.VarChar(500)
  filename     String    @db.VarChar(255)
  mimetype     String    @db.VarChar(100)
  size         Int
  type         MediaType
  uploadedById String?   @map("uploaded_by_id")
  isDeleted    Boolean   @default(false) @map("is_deleted")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  uploadedBy    User?          @relation("UserUploadedMedia", fields: [uploadedById], references: [id], onDelete: SetNull)
  productImages ProductImage[]
  reviewImages  ReviewImage[]
  userAvatars   User[]         @relation("UserAvatar")
  categories    Category[]     @relation("CategoryImage")
  brands        Brand[]        @relation("BrandLogo")
  banners       Banner[]       @relation("BannerImage")

  @@index([type])
  @@index([uploadedById])
  @@index([key])
  @@map("media")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  variantId String   @map("variant_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
  @@map("cart_items")
}

model Order {
  id                String      @id @default(uuid())
  userId            String      @map("user_id")
  orderNumber       String      @unique @map("order_number") @db.VarChar(50)
  status            OrderStatus @default(PENDING)
  subtotal          Decimal     @db.Decimal(10, 2)
  tax               Decimal     @default(0) @db.Decimal(10, 2)
  shipping          Decimal     @default(0) @db.Decimal(10, 2)
  discount          Decimal     @default(0) @db.Decimal(10, 2)
  total             Decimal     @db.Decimal(10, 2)
  shippingAddressId String?     @map("shipping_address_id")
  affiliateCode     String?     @map("affiliate_code") @db.VarChar(50)
  couponCode        String?     @map("coupon_code") @db.VarChar(50)
  notes             String?     @db.Text
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  user            User                  @relation(fields: [userId], references: [id])
  shippingAddress Address?              @relation(fields: [shippingAddressId], references: [id], onDelete: SetNull)
  items           OrderItem[]
  payments        Payment[]
  commissions     AffiliateCommission[]
  couponUsage     CouponUsage?
  flashSaleOrder  FlashSaleOrder?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([affiliateCode])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  variantId String   @map("variant_id")
  name      String   @db.VarChar(255)
  sku       String   @db.VarChar(100)
  price     Decimal  @db.Decimal(10, 2)
  quantity  Int      @default(1)
  total     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  CREDIT_CARD
  E_WALLET
  MOMO
  ZALOPAY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String        @map("order_id")
  method        PaymentMethod
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique @map("transaction_id") @db.VarChar(255)
  paymentData   String?       @map("payment_data") @db.Text
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

// Product statistics for performance optimization
// This table stores pre-calculated metrics to avoid expensive aggregate queries

model ProductStats {
  id           String    @id @default(uuid())
  productId    String    @unique @map("product_id")
  totalSold    Int       @default(0) @map("total_sold")
  totalRevenue Decimal   @default(0) @map("total_revenue") @db.Decimal(15, 2)
  avgRating    Decimal?  @map("avg_rating") @db.Decimal(3, 2)
  reviewCount  Int       @default(0) @map("review_count")
  viewCount    Int       @default(0) @map("view_count")
  lastSoldAt   DateTime? @map("last_sold_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([totalSold])
  @@index([avgRating])
  @@map("product_stats")
}

enum CateGoryType {
  BRAND
  CATEGORY
}

model Category {
  id           String       @id @default(uuid())
  name         String       @db.VarChar(255)
  slug         String       @unique @db.VarChar(255)
  description  String?      @db.Text
  imageMediaId String?      @map("image_media_id")
  parentId     String?      @map("parent_id")
  isActive     Boolean      @default(true) @map("is_active")
  sortOrder    Int          @default(0) @map("sort_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  brandId      String?      @map("brand_id")
  type         CateGoryType @default(CATEGORY)

  parent            Category?         @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children          Category[]        @relation("CategoryTree")
  imageMedia        Media?            @relation("CategoryImage", fields: [imageMediaId], references: [id], onDelete: SetNull)
  brand             Brand?            @relation("BrandCategory", fields: [brandId], references: [id], onDelete: SetNull)
  productCategories ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@index([imageMediaId])
  @@map("categories")
}

model Brand {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text
  logoMediaId String?  @map("logo_media_id")
  website     String?  @db.VarChar(500)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  products   Product[]
  logoMedia  Media?     @relation("BrandLogo", fields: [logoMediaId], references: [id], onDelete: SetNull)
  categories Category[] @relation("BrandCategory")

  @@index([slug])
  @@index([logoMediaId])
  @@map("brands")
}

model Product {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(255)
  slug         String   @unique @db.VarChar(255)
  description  String?  @db.Text
  shortDesc    String?  @map("short_desc") @db.VarChar(500)
  sku          String   @unique @db.VarChar(100)
  brandId      String?  @map("brand_id")
  basePrice    Decimal  @map("base_price") @db.Decimal(10, 2)
  comparePrice Decimal? @map("compare_price") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")
  isFeatured   Boolean  @default(false) @map("is_featured")
  weight       Decimal? @db.Decimal(8, 2)
  metaTitle    String?  @map("meta_title") @db.VarChar(255)
  metaDesc     String?  @map("meta_desc") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  brand             Brand?             @relation(fields: [brandId], references: [id], onDelete: SetNull)
  badges            ProductBadge[]
  variants          ProductVariant[]
  images            ProductImage[]
  reviews           ProductReview[]
  orderItems        OrderItem[]
  cartItems         CartItem[]
  promotions        PromotionProduct[]
  commRates         CommissionRate[]
  flashSaleProducts FlashSaleProduct[]
  productCategories ProductCategory[]
  stats             ProductStats?

  @@index([slug])
  @@index([brandId])
  @@index([sku])
  @@map("products")
}

enum ProductBadgeType {
  NEW
  SALE
  BEST_SELLER
  FREESHIPPING
}

enum ProductBadgeVariant {
  PRIMARY
  INFO
  NEUTRAL
}

model ProductBadge {
  id        String              @id @default(uuid())
  productId String              @map("product_id")
  name      String              @db.VarChar(255)
  sortOrder Int                 @default(0) @map("sort_order")
  isActive  Boolean             @default(true) @map("is_active")
  variant   ProductBadgeVariant @default(INFO)
  type      ProductBadgeType    @default(NEW)
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_badges")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  sku       String   @unique @db.VarChar(100)
  name      String   @db.VarChar(255)
  color     String?  @db.VarChar(100)
  size      String?  @db.VarChar(100)
  type      String?  @db.VarChar(100)
  price     Decimal  @db.Decimal(10, 2)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory         ProductInventory?
  images            ProductImage[]
  orderItems        OrderItem[]
  cartItems         CartItem[]
  flashSaleProducts FlashSaleProduct[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  mediaId   String   @map("media_id")
  alt       String?  @db.VarChar(255)
  sortOrder Int      @default(0) @map("sort_order")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  media   Media           @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([mediaId])
  @@index([variantId])
  @@map("product_images")
}

enum ProductInventoryDisplayStatus {
  IN_STOCK
  OUT_OF_STOCK
}

model ProductInventory {
  id                String                        @id @default(uuid())
  variantId         String                        @unique @map("variant_id")
  quantity          Int                           @default(0)
  displayStatus     ProductInventoryDisplayStatus @default(IN_STOCK) @map("display_status")
  lowStockThreshold Int                           @default(10) @map("low_stock_threshold")
  createdAt         DateTime                      @default(now()) @map("created_at")
  updatedAt         DateTime                      @updatedAt @map("updated_at")

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@map("product_inventory")
}

model ProductCategory {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@map("product_categories")
}

model Promotion {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  type        String   @db.VarChar(50)
  value       Decimal  @db.Decimal(10, 2)
  minPurchase Decimal? @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount Decimal? @map("max_discount") @db.Decimal(10, 2)
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  products PromotionProduct[]

  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("promotions")
}

model PromotionProduct {
  id          String   @id @default(uuid())
  promotionId String   @map("promotion_id")
  productId   String   @map("product_id")
  createdAt   DateTime @default(now()) @map("created_at")

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([promotionId, productId])
  @@index([promotionId])
  @@index([productId])
  @@map("promotion_products")
}

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(50)
  type        String   @db.VarChar(50)
  value       Decimal  @db.Decimal(10, 2)
  minPurchase Decimal? @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount Decimal? @map("max_discount") @db.Decimal(10, 2)
  usageLimit  Int?     @map("usage_limit")
  usedCount   Int      @default(0) @map("used_count")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  usages CouponUsage[]

  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("coupons")
}

model CouponUsage {
  id        String   @id @default(uuid())
  couponId  String   @map("coupon_id")
  orderId   String   @unique @map("order_id")
  discount  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([orderId])
  @@map("coupon_usages")
}

model ProductReview {
  id           String   @id @default(uuid())
  productId    String   @map("product_id")
  userId       String   @map("user_id")
  rating       Int      @db.SmallInt
  title        String?  @db.VarChar(255)
  comment      String?  @db.Text
  isVerified   Boolean  @default(false) @map("is_verified")
  isApproved   Boolean  @default(false) @map("is_approved")
  helpfulCount Int      @default(0) @map("helpful_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewImages ReviewImage[]

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("product_reviews")
}

model ReviewImage {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  mediaId   String   @map("media_id")
  alt       String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  review ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  media  Media         @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([mediaId])
  @@map("review_images")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model AuthCode {
  id        String   @id @default(uuid())
  authCode  String?  @default(uuid()) @map("auth_code")
  roleLevel Int?     @default(0) @map("role_level")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([authCode])
  @@map("auth_codes")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  firstName     String   @map("first_name") @db.VarChar(255)
  lastName      String   @map("last_name") @db.VarChar(255)
  phone         String   @unique
  username      String   @unique
  password      String   @db.VarChar(255)
  avatarMediaId String?  @map("avatar_media_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  refreshToken  String?  @map("refresh_token")

  isActive              Boolean                @default(true) @map("is_active")
  isVerified            Boolean                @default(false) @map("is_verified")
  isBanned              Boolean                @default(false) @map("is_banned")
  isDeleted             Boolean                @default(false) @map("is_deleted")
  isEmailVerified       Boolean                @default(false) @map("is_email_verified")
  isPhoneVerified       Boolean                @default(false) @map("is_phone_verified")
  emailVerifiedAt       DateTime?              @map("email_verified_at")
  phoneVerifiedAt       DateTime?              @map("phone_verified_at")
  // Relations
  cart                  Cart?
  orders                Order[]
  reviews               ProductReview[]
  addresses             Address[]
  affiliate             Affiliate?
  roleAssignments       UserRoleAssignment[]
  avatarMedia           Media?                 @relation("UserAvatar", fields: [avatarMediaId], references: [id], onDelete: SetNull)
  uploadedMedia         Media[]                @relation("UserUploadedMedia")
  emailVerificationLogs EmailVerificationLog[]

  @@index([email])
  @@index([phone])
  @@index([username])
  @@index([avatarMediaId])
  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  roleAssignments UserRoleAssignment[]

  @@index([name])
  @@map("user_roles")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role UserRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_role_assignments")
}
